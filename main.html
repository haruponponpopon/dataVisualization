<!DOCTYPE html>
<html lang="en"><head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <link rel="stylesheet" href="style.css">
        <title>Stores in Japan</title>
        <script src="./d3.js" charset="utf-8"></script>
        <script src="./topojson.js" charset="utf-8"></script>
        <!-- <script src="./japan_graph.js" charset="utf-8"></script> -->
        <script src="./prefecture_map.js" charset="utf-8"></script>
        <script src="./data/data_graph/unagi_line.js" charset="utf-8"></script>
        <script src="./japan_graph.js" charset="utf-8"></script>
        <!-- <script src="./prefecture_graph.js" charset="utf-8"></script> -->
</head>
<body>
<label for="genreChoiceBox">ジャンルを選択してください</label>
<select id="genreChoiceBox" multiple> </select>

<div id="contentDiv"></div>

<script type="text/javascript">
var width = 800;
var height = 800;

var choice_genres = {}
ShopData[0]["genre"].forEach(function(elem, index) {
    choice_genres[elem] = false;
});


var svgJapanMap = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var svgPrefectureMap = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var data_selectedPrefecture = null;
var topojsonPrefecture = makeTopojsonPrefecture();

// ジャンル選択ボタン
var selectGenre = document.getElementById("genreChoiceBox");
function addOptionGenre() {
    for (key in choice_genres) {
        var option = document.createElement("option");
        option.text = key;
        option.value = key;
        selectGenre.appendChild(option);
    }
}
addOptionGenre();

// 年度指定のスクロールバー

// データの読み込み

// 日本地図の表示
// 都道府県の地図の表示
showJapanMap(svgJapanMap, svgPrefectureMap);

// 全国のグラフの表示

drawAll(ShopData, "contentDiv");
console.log(choice_legend);


// 都道府県のグラフの表示


// 日本地図の処理

function showJapanMap(svg, svgPrefectureMap){
    var tooltip = d3.select("body").append("div").attr("class", "tooltip");
    var selectedPrefecture = null;
    var isSelected = false;

    d3.json("./japan.topojson").then(function(data){
        var japan = topojson.feature(data, data.objects.japan);

        var projection = d3.geoMercator()
            .center([140, 35])
            .translate([width/2, height/2])
            .scale(1500);
        var path = d3.geoPath().projection(projection);

        svg.on("click", svgClicked);

        console.log(japan.features);
        var prefectures = svg.selectAll("path")
            .data(japan.features)
            .enter().append("g")
            .append("path")
            .attr("d", path)
            .attr("fill", "ivory")
            .attr("stroke", "#333333")
            .on("mouseover", function(event, d){
                tooltip
                    .style("visibility", "visible")
                    .html(d.properties.nam_ja);
            })
            .on("mousemove", function(event, d){
                tooltip
                    .style("top", (event.pageY - 40) + "px")
                    .style("left", (event.pageX - 30) + "px");
            })
            .on("mouseout", function() {
                tooltip.style("visibility", "hidden");
            })
            .on("click", prefectureClicked);
        
        var zoom = d3.zoom()
            .scaleExtent([1, 10])
            .on("zoom", function(event){
                prefectures.attr("transform", event.transform);
            })
        
        svg.call(zoom);

        const defaultText = "都道府県を選択してください";
        var textShowPrefecture = svg.append("text")
            .attr("x", 20)
            .attr("y", 60)
            .text(defaultText);

        function svgClicked(){
            if (isSelected){
                isSelected = false;
            } else{
                prefectures.attr("fill", "ivory");
                selectedPrefecture = null;
                data_selectedPrefecture = null;
            }
            textShowPrefecture.text(function() {
                return selectedPrefecture ? `選択された都道府県：${selectedPrefecture}` : defaultText;
            });
        }

        function prefectureClicked(event, d){
            isSelected = true;
            data_selectedPrefecture = d;
            selectedPrefecture = d.properties.nam_ja;
            prefectures.attr("fill", function(d){
                    return d.properties.nam_ja === selectedPrefecture ? "lightgreen" : "ivory";
                });
            showPrefectureMap(svgPrefectureMap);
        }
    });
}

function showPrefectureMap(svg){
    var prefecture = topojson.feature(...topojsonPrefecture[data_selectedPrefecture.properties.id]);
    var center = d3.geoCentroid(data_selectedPrefecture);

    var projection_pref = d3.geoMercator()
        .center(center)
        .translate([width/2, height/2])
        .scale(4500);

    var path_pref = d3.geoPath().projection(projection_pref);

    var selectedPref = svg.selectAll("path.pref")
        .data(prefecture.features)
        .enter().append("g")
        .append("path")
        .attr("d", path_pref)
        .attr("fill", "ivory")
        .attr("stroke", "#333333");
}


</script>
</body></html>
