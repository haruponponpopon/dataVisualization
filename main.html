<!DOCTYPE html>
<html lang="en"><head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <link rel="stylesheet" href="style.css">
        <title>Stores in Japan</title>
        <script src="./d3.js" charset="utf-8"></script>
        <script src="./topojson.js" charset="utf-8"></script>
        <script src="./data/data_plot/unagi_plot.js" charset="utf-8"></script>
        <!-- <script src="./japan_graph.js" charset="utf-8"></script> -->
        <script src="./prefecture_map.js" charset="utf-8"></script>
        <script src="./data/data_graph/unagi_line_v2.js" charset="utf-8"></script>
        <script src="./data/data_graph/unagi_line_pref_v2.js" charset="utf-8"></script>
        <script src="./japan_graph.js" charset="utf-8"></script>
        <script src="./prefecture_graph.js" charset="utf-8"></script>
        <!-- <script src="./prefecture_graph.js" charset="utf-8"></script> -->
</head>
<body>
<input type="range" id = "yearInput">
<h2><span id="yearCurrentValue"></span></h2>

<div id="contentDiv"></div>
<div id="contentDivPre"></div>

<script type="text/javascript">
var width = 800;
var height = 800;

var choice_genres = {};
for(var i of ShopData[0].genre) {
    choice_genres[i] = false;
}
var true_num = 0;

var color_palette = ["#7D74FE","#7DFF26","#F84F1B","#28D8D5","#FB95B6","#9D9931","#F12ABF","#27EA88","#549AD5","#FEA526","#7B8D8B","#BB755F","#432E16",
"#D75CFB","#44E337","#51EBE3","#ED3D24","#4069AE","#E1CC72","#E33E88","#D8A3B3","#428B50","#66F3A3","#E28A2A","#B2594D","#609297","#E8F03F","#3D2241",
"#954EB3","#6A771C","#58AE2E","#75C5E9","#BBEB85","#A7DAB9","#6578E6","#932C5F","#865A26","#CC78B9","#2E5A52","#8C9D79","#9F6270","#6D3377","#551927","#DE8D5A",
"#E3DEA8","#C3C9DB","#3A5870","#CD3B4F","#E476E3","#DCAB94","#33386D","#4DA284","#817AA5","#8D8384","#624F49","#8E211F","#9E785B","#355C22","#D4ADDE",
"#A98229","#E88B87","#28282D","#253719","#BD89E1","#EB33D8","#6D311F","#DF45AA","#E86723","#6CE5BC","#765175","#942C42","#986CEB","#8CC488","#8395E3",
"#D96F98","#9E2F83","#CFCBB8","#4AB9B7","#E7AC2C","#E96D59","#929752","#5E54A9","#CCBA3F","#BD3CB8","#408A2C","#8AE32E","#5E5621","#ADD837","#BE3221","#8DA12E",
"#3BC58B","#6EE259","#52D170","#D2A867","#5C9CCD","#DB6472","#B9E8E0","#CDE067","#9C5615","#536C4F","#A74725","#CBD88A","#DF3066","#E9D235","#EE404C","#7DB362",
"#B1EDA3","#71D2E1","#A954DC","#91DF6E","#CB6429","#D64ADC"];

var colors = {};
var index = 0;
for (var c of color_palette) {
	colors[index] = {color: c, genre:undefined};
	index++;
}

var current_date;
var current_pre = undefined;


sessionStorage.setItem("choice_genres" , JSON.stringify(choice_genres));
sessionStorage.setItem("true_num", true_num);
sessionStorage.setItem("colors" , JSON.stringify(colors));
sessionStorage.setItem("current_pre" , current_pre);


// 選択状態の更新用関数
function pull_all_data() {
    choice_genres = JSON.parse(sessionStorage.getItem("choice_genres"));
    true_num = JSON.parse(sessionStorage.getItem("true_num"));
	colors = JSON.parse(sessionStorage.getItem("colors"));
    current_date = JSON.parse(sessionStorage.getItem("current_date"));
}

function push_all_data() {
    sessionStorage.setItem("choice_genres" , JSON.stringify(choice_genres) );
    sessionStorage.setItem("true_num", true_num);
    sessionStorage.setItem("colors", JSON.stringify(colors));
    sessionStorage.setItem("current_date" , JSON.stringify(current_date));
}


var svgJapanMap = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var svgPrefectureMap = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var data_selectedPrefecture = undefined;
var topojsonPrefecture = makeTopojsonPrefecture();

const genreMap = new Map([
    ["unagi", unagi]
]);

let selectedGenre = "unagi";
let currentYear = 2021;
let currentMonth = 3;

// ジャンル選択ボタン

// 年度指定のスクロールバー
var year_input = document.getElementById("yearInput");
var min_date_list = ShopData[0].min_date.split("-");
var max_date_list = ShopData[0].max_date.split("-");
dateMin = Number(min_date_list[0]) + 1/12*(Number(min_date_list[1])-1);
dateMax = Number(max_date_list[0]) + 1/12*(Number(max_date_list[1])-1);
year_input.min = dateMin;
year_input.max = dateMax;
year_input.value = dateMin;
year_input.step = 1/12;
var year_current_value = document.getElementById("yearCurrentValue");
// 現在の値をspanに埋め込む関数
const setCurrentValue = (val) => {
    var year = Math.floor(val);
    var month = Math.round((val - year) * 12) + 1;
    current_date = val;
    sessionStorage.setItem("current_date" , JSON.stringify(current_date));
    year_current_value.innerText = "" + year + "-" + month;
    updateVline(ShopData, "contentDiv");
    updateVlinePre(ShopPrefectureData, "contentDivPre");
}

// inputイベント時に値をセットする関数
const rangeOnChange = (e) =>{
    setCurrentValue(e.target.value);
}

window.onload = () => {
    year_input.addEventListener('input', rangeOnChange); // スライダー変化時にイベントを発火
    setCurrentValue(year_input.value); // ページ読み込み時に値をセット
}

// データの読み込み

// 日本地図の表示
// 都道府県の地図の表示
showJapanMap(svgJapanMap, svgPrefectureMap);

// 全国のグラフの表示

drawAll(ShopData, "contentDiv");


// 都道府県のグラフの表示
initAllPre(ShopPrefectureData, "contentDivPre");

// ---------都道府県グラフの更新はこんな感じ-----------
current_pre = "北海道";
sessionStorage.setItem("current_pre" , current_pre);

drawAllPre(ShopPrefectureData, "contentDivPre");
// ---------都道府県グラフの更新はこんな感じ-----------


// 日本地図の処理

function showJapanMap(svg, svgPrefectureMap){
    var tooltip = d3.select("body").append("div").attr("class", "tooltip");
    var selectedPrefecture = undefined;
    var isSelected = false;

    d3.json("./japan.topojson").then(function(data){
        var japan = topojson.feature(data, data.objects.japan);

        var projection = d3.geoMercator()
            .center([140, 35])
            .translate([width/2, height/2])
            .scale(1500);
        var path = d3.geoPath().projection(projection);

        svg.on("click", svgClicked);

        console.log(japan.features);
        var prefectures = svg.selectAll("path")
            .data(japan.features)
            .enter().append("g")
            .append("path")
            .attr("d", path)
            .attr("fill", "ivory")
            .attr("stroke", "#333333")
            .on("mouseover", function(event, d){
                tooltip
                    .style("visibility", "visible")
                    .html(d.properties.nam_ja);
            })
            .on("mousemove", function(event, d){
                tooltip
                    .style("top", (event.pageY - 40) + "px")
                    .style("left", (event.pageX - 30) + "px");
            })
            .on("mouseout", function() {
                tooltip.style("visibility", "hidden");
            })
            .on("click", prefectureClicked);

        var plot = svg.selectAll("circle.plot")
            .data(genreMap.get(selectedGenre)[currentYear][currentMonth])
            .enter().append("g")
            .append("circle")
            .attr("cx", function(d){
                return projection(d.longitude_latitude)[0];
            })
            .attr("cy", function(d){
                return projection(d.longitude_latitude)[1];
            })
            .attr("r", 3)
            .attr("fill", function(d){
                return d.open ? "red" : "blue";
            });
        
        var zoom = d3.zoom()
            .scaleExtent([1, 10])
            .on("zoom", function(event){
                prefectures.attr("transform", event.transform);
                plot.attr("transform", event.transform);
            })
        
        svg.call(zoom);

        const defaultText = "都道府県を選択してください";
        var textShowPrefecture = svg.append("text")
            .attr("x", 20)
            .attr("y", 60)
            .text(defaultText);

        function svgClicked(){
            if (isSelected){
                isSelected = false;
            } else{
                prefectures.attr("fill", "ivory");
                selectedPrefecture = undefined;
                data_selectedPrefecture = undefined;
            }

            textShowPrefecture.text(function() {
                return selectedPrefecture ? `選択された都道府県：${selectedPrefecture}` : defaultText;
            });
        }

        function prefectureClicked(event, d){
            isSelected = true;
            data_selectedPrefecture = d;
            selectedPrefecture = d.properties.nam_ja;
            prefectures.attr("fill", function(d){
                    return d.properties.nam_ja === selectedPrefecture ? "lightgreen" : "ivory";
                });
            
            showPrefectureMap(svgPrefectureMap);
        }
    });
}

function showPrefectureMap(svg){
    var prefecture = topojson.feature(...topojsonPrefecture[data_selectedPrefecture.properties.id]);
    var center = d3.geoCentroid(data_selectedPrefecture);

    var projection_pref = d3.geoMercator()
        .center(center)
        .translate([width/2, height/2])
        .scale(4500);

    var path_pref = d3.geoPath().projection(projection_pref);

    var selectedPref = svg.selectAll("path.pref")
        .data(prefecture.features)
        .enter().append("g")
        .append("path")
        .attr("d", path_pref)
        .attr("fill", "ivory")
        .attr("stroke", "#333333");

    var plotPref = svg.selectAll("circle.plotPref")
        .data(getPlotDataPref())
        .enter().append("g")
        .append("circle")
        .attr("cx", function(d){
            return projection_pref(d.longitude_latitude)[0];
        })
        .attr("cy", function(d){
            return projection_pref(d.longitude_latitude)[1];
        })
        .attr("r", 3)
        .attr("fill", function(d){
            return d.open ? "red" : "blue";
        });
    
    function getPlotDataPref(){
        let result = [];
        const data = genreMap.get(selectedGenre)[currentYear][currentMonth];
        data.forEach(function(element){
            if (element.prefecture === data_selectedPrefecture.properties.nam_ja){
                result.push(element);
            }
        });
        return result;
    }
}

</script>
</body></html>
